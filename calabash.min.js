/*! calabash - v0.0.1 - 2012-09-20
* Copyright (c) 2012 sam l'ecuyer; Licensed MIT */
(function(e,t){"use strict";function s(){}function o(e){return e}function u(e,t){var n={},r;return n.next=function(t){return g(e(r),t),this},n.start=function(e){return r=e,this},n}function a(e,t){var r=n.apply(arguments,[2]);return function(){return e.apply(t||{},r.concat(n.apply(arguments)))}}function f(e,t){return g(e,t,t)}function l(e,t){return e.then(o,t)}function c(e,t,n){return g(e,function(e){try{return y(e[t].apply(e,n))}catch(r){return C(r)}})}function h(e,t,n){return g(e).then(function(e){return arguments.length===3?(e[t]=n,y(e)):y(e[t])})}function p(e,n){var r=v(),i=setTimeout(function(){i&&r.reject("timeout")},n);return g(e,function(e){clearTimeout(i),i=t,r.resolve(e)},function(e){clearTimeout(i),i=t,r.reject(e)}),r.promise}function d(){}function v(){var e=!1,t=[],n={},i=Object.create(d.prototype),s,o=function(e,n){var r=v();return t.push(function(t){t.then(e,n).then(r.resolve,r.reject)}),r.promise};n.then=i.then=function(e,t){return o(e,t)},n.promise=r(i);var u=function(n){if(!e){e=!0,s=y(n);while(t[0]){var r=t.shift();r(s)}}return s};return n.resolve=function(e){return u(e)},n.reject=function(e){return u(C(e))},n}function m(e){var t=v();return k(function(){try{t.resolve(e())}catch(n){t.reject(n)}}),t.promise}function g(e,t,n){return y(e).then(t,n)}function y(e){return O(e)?e:N(e)}function b(e,t,n){return g(e,function(e){return x(e,T)}).then(t,n)}function w(e,n,r){return b(e).then(function(e){n.call(t,e)},r)}function E(e,t){return g(e,function(e){var n=e.map(function(e){return g(e,t)});return x(n,T)})}function S(e,t,n,r){var i=e.length-t;return g(e,function(e){var s=v(),o=[];return k(function(){e.forEach(function(e){g(e,function(e){o.push(e),o.length>=t&&s.resolve(o)},function(){--i<=0&&s.reject("too many failures")})})}),g(s.promise,n,r)},r)}function x(e,t){return e.reduce(function(e,n,r){return g(e,function(e){return g(n,function(n){return t(e,r,n)})})},[])}function T(e,t,n){return e[t]=n,e}function N(e){var t=new d;return t.then=function(t){try{return t&&typeof t==typeof []?t.reduce(function(e,t){return e.then(t)},y(e)):y(t?t(e):e)}catch(n){return C(n)}},r(t)}function C(e){var t=new d;return t.then=function(t,n){try{return n?y(n(e)):C(e)}catch(r){return C(r)}},r(t)}function O(e){return e&&e instanceof d}function M(e,t){var n=v();return k(function(){try{var r=new XMLHttpRequest;r.open(t.method||"GET",e,!0),r.onload=function(){n.resolve(this)},r.onerror=r.onabort=r.ontimeout=function(e){n.reject(e)},r.send()}catch(i){n.reject(i)}}),n.promise}function _(e){return M(e,{method:"GET"}).then(function(e){if(e.status>=400)throw e.status;return e.response})}var n=Array.prototype.slice,r=Object.freeze,i;i=function(){},i.iter=u,i.bind=a,i.always=f,i.fail=l,i.apply=c,i.val=h,i.timeout=p,i.Promise=d,["always","fail","val","apply","timeout","all"].forEach(function(t){d.prototype[t]=function(){return i[t].apply(e,[this].concat(n.call(arguments)))}}),r(d.prototype),i.defer=v,i.fcall=m,i.when=g,i.resolve=y,i.all=b,i.spread=w,i.map=E,i.some=S;var k;if(e.MessageChannel){var L=[],A=new e.MessageChannel;A.port1.onmessage=function(){var e=L.shift();e()},k=function(e){L.push(e),A.port2.postMessage(t)}}else k=function(e){setTimeout(e,1)};i.enqueue=k,i.isPromise=O,i.ajax=M,i.get=_,e.K=i,e.Calabash=i})(window);